#!/usr/bin/envÂ python3
#Â -*-Â coding:Â utf-8Â -*-

#Â Ğ’ĞĞ–ĞĞÂ Ğ”Ğ›Ğ¯Â GOOGLEÂ COLAB:
#Â ĞŸĞµÑ€ĞµĞ´Â Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼Â ÑÑ‚Ğ¾Ğ³Ğ¾Â ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°Â Ğ²Â GoogleÂ Colab,Â Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµÂ Ğ²Â Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹Â ÑÑ‡ĞµĞ¹ĞºĞµ:
!sudoÂ apt-getÂ updateÂ &&Â sudoÂ apt-getÂ installÂ -yÂ libxcb-cursor0
#Â Ğ—Ğ°Ñ‚ĞµĞ¼Â ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼Â Calibre
!sudoÂ -vÂ &&Â wgetÂ -nvÂ -O-Â https://download.calibre-ebook.com/linux-installer.shÂ |Â sudoÂ shÂ /dev/stdin
#Â Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°Â Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹Â PythonÂ (ĞµÑĞ»Ğ¸Â ĞµÑ‰ĞµÂ Ğ½ĞµÂ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹)
!pipÂ installÂ python-docxÂ docxcomposeÂ beautifulsoup4Â ebooklibÂ aiogramÂ aiofilesÂ nest_asyncio

importÂ os
importÂ re
importÂ time
importÂ docxÂ #Â ĞÑÑ‚Ğ°ĞµÑ‚ÑÑÂ Ğ´Ğ»ÑÂ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ÑÂ "Ğ¾ÑˆĞ¸Ğ±Ğ¾Ñ‡Ğ½Ñ‹Ñ…"Â DOCXÂ Ğ¸Â Ğ´Ğ»ÑÂ check_and_add_title
importÂ aiogram
fromÂ docxÂ importÂ DocumentÂ #Â Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑÂ Ğ´Ğ»ÑÂ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ÑÂ Ğ¿ÑƒÑÑ‚Ñ‹Ñ…/Ğ¾ÑˆĞ¸Ğ±Ğ¾Ñ‡Ğ½Ñ‹Ñ…Â Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
fromÂ docx.sharedÂ importÂ InchesÂ #Â ĞœĞ¾Ğ¶ĞµÑ‚Â Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑŒÑÑÂ ĞµÑĞ»Ğ¸Â check_and_add_titleÂ Ğ±ÑƒĞ´ĞµÑ‚Â Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒÂ ÑÂ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°Ğ¼Ğ¸
#Â PIL,Â base64,Â posixpath,Â ebooklib,Â BeautifulSoupÂ -Â Ğ±Ğ¾Ğ»ÑŒÑˆĞµÂ Ğ½ĞµÂ Ğ½ÑƒĞ¶Ğ½Ñ‹Â Ğ´Ğ»ÑÂ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸,Â Ğ½Ğ¾Â Ğ¼Ğ¾Ğ³ÑƒÑ‚Â Ğ±Ñ‹Ñ‚ÑŒÂ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Â Ğ´Ğ»ÑÂ check_and_add_titleÂ Ğ¸Ğ»Ğ¸Â Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…Â Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ñ…Â Ñ„Ğ¸Ñ‡
fromÂ docxcompose.composerÂ importÂ Composer
fromÂ aiogramÂ importÂ Bot,Â Router,Â types,Â F,Â Dispatcher
fromÂ aiogram.typesÂ importÂ Message,Â FSInputFile,Â BotCommand,Â BotCommandScopeDefault,Â BotCommandScopeAllGroupChats
fromÂ aiogram.filtersÂ importÂ Command
fromÂ aiogram.utils.keyboardÂ importÂ ReplyKeyboardBuilder
#Â fromÂ aiogram.utilsÂ importÂ markdownÂ asÂ mdÂ #Â ĞĞµÂ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑÂ ÑĞ²Ğ½Ğ¾
importÂ aiofiles
importÂ asyncio
importÂ nest_asyncio
importÂ concurrent.futures
fromÂ aiogram.fsm.contextÂ importÂ FSMContext
fromÂ aiogram.fsm.stateÂ importÂ State,Â StatesGroup
fromÂ aiogram.fsm.storage.memoryÂ importÂ MemoryStorage
fromÂ functoolsÂ importÂ partial
fromÂ collectionsÂ importÂ deque
fromÂ datetimeÂ importÂ datetime,Â timezone,Â timedelta
nest_asyncio.apply()
fromÂ aiogram.typesÂ importÂ InlineKeyboardMarkup,Â InlineKeyboardButton,Â CallbackQuery,Â ReplyKeyboardRemove
fromÂ aiogram.exceptionsÂ importÂ TelegramBadRequest
importÂ subprocessÂ #Â Ğ”Ğ»ÑÂ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°Â Calibre

#Â Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼Â Ğ¿ÑƒĞ»Â Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²Â Ğ´Ğ»ÑÂ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸ÑÂ CPU-boundÂ Ğ·Ğ°Ğ´Ğ°Ñ‡Â (Ğ²ĞºĞ»ÑÑ‡Ğ°ÑÂ Calibre)
thread_poolÂ =Â concurrent.futures.ThreadPoolExecutor(max_workers=1)

#Â ---Â ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸Â CalibreÂ ---
CALIBRE_CONVERT_PATHÂ =Â "/opt/calibre/ebook-convert"
IS_CALIBRE_AVAILABLEÂ =Â False

asyncÂ defÂ check_calibre_availability():
Â Â Â Â """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚Â Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒÂ CalibreÂ Ğ¿Ñ€Ğ¸Â Ğ·Ğ°Ğ¿ÑƒÑĞºĞµÂ Ğ±Ğ¾Ñ‚Ğ°."""
Â Â Â Â globalÂ IS_CALIBRE_AVAILABLE
Â Â Â Â ifÂ os.path.exists(CALIBRE_CONVERT_PATH)Â andÂ os.access(CALIBRE_CONVERT_PATH,Â os.X_OK):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â processÂ =Â awaitÂ asyncio.create_subprocess_exec(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â CALIBRE_CONVERT_PATH,Â '--version',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â stdout=asyncio.subprocess.PIPE,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â stderr=asyncio.subprocess.PIPE)
Â Â Â Â Â Â Â Â Â Â Â Â stdout,Â stderrÂ =Â awaitÂ process.communicate()
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ process.returncodeÂ ==Â 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â IS_CALIBRE_AVAILABLEÂ =Â True
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"CalibreÂ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Â Ğ¸Â Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:Â {CALIBRE_CONVERT_PATH}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"Ğ’ĞµÑ€ÑĞ¸ÑÂ Calibre:Â {stdout.decode(errors='ignore').strip()}")
Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"CalibreÂ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Â ({CALIBRE_CONVERT_PATH}),Â Ğ½Ğ¾Â ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Â --versionÂ Ğ½ĞµÂ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ.Â Stderr:Â {stderr.decode(errors='ignore')}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â IS_CALIBRE_AVAILABLEÂ =Â False
Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµÂ Calibre:Â {e}")
Â Â Â Â Â Â Â Â Â Â Â Â IS_CALIBRE_AVAILABLEÂ =Â False
Â Â Â Â else:
Â Â Â Â Â Â Â Â print(f"CalibreÂ (ebook-convert)Â Ğ½ĞµÂ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Â Ğ¸Ğ»Ğ¸Â Ğ½ĞµÂ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¹Â Ğ¿Ğ¾Â Ğ¿ÑƒÑ‚Ğ¸Â {CALIBRE_CONVERT_PATH}.")
Â Â Â Â Â Â Â Â IS_CALIBRE_AVAILABLEÂ =Â False

asyncÂ defÂ set_bot_commands(bot:Â Bot):
Â Â Â Â commandsÂ =Â [
Â Â Â Â Â Â Â Â BotCommand(command="start_merge",Â description="ĞĞ°Ñ‡Ğ°Ñ‚ÑŒÂ ÑĞ±Ğ¾Ñ€Â Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"),
Â Â Â Â Â Â Â Â BotCommand(command="end_merge",Â description="Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒÂ ÑĞ±Ğ¾Ñ€Â Ğ¸Â Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ"),
Â Â Â Â Â Â Â Â BotCommand(command="cancel",Â description="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÂ ÑĞ±Ğ¾Ñ€"),
Â Â Â Â Â Â Â Â BotCommand(command="queue_status",Â description="Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÂ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸Â Ğ·Ğ°Ğ´Ğ°Ñ‡"),
Â Â Â Â Â Â Â Â BotCommand(command="limits",Â description="ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒÂ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹"),
Â Â Â Â Â Â Â Â BotCommand(command="info",Â description="Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ÑÂ Ğ¾Â Ğ±Ğ¾Ñ‚ĞµÂ Ğ¸Â ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹"),
Â Â Â Â ]
Â Â Â Â awaitÂ bot.set_my_commands(commands,Â scope=BotCommandScopeDefault())
Â Â Â Â awaitÂ bot.set_my_commands(commands,Â scope=BotCommandScopeAllGroupChats())

asyncÂ defÂ sanitize_filename(file_name):
Â Â Â Â replacementÂ =Â '_'
Â Â Â Â invalid_chars_patternÂ =Â r'[<>:"/|\?*]'
Â Â Â Â sanitizedÂ =Â re.sub(invalid_chars_pattern,Â replacement,Â file_name)
Â Â Â Â max_lenÂ =Â 250
Â Â Â Â returnÂ sanitized[:max_len]

asyncÂ defÂ check_sender(message:Â types.Message):
Â Â Â Â ifÂ message.sender_chat:
Â Â Â Â Â Â Â Â bot_messageÂ =Â awaitÂ message.reply("ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹ĞµÂ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸Â (Ğ¾Ñ‚Â Ğ¸Ğ¼ĞµĞ½Ğ¸Â ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²/Ğ³Ñ€ÑƒĞ¿Ğ¿)Â Ğ½ĞµÂ Ğ¼Ğ¾Ğ³ÑƒÑ‚Â Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÂ ÑÑ‚Ğ¾Ğ³Ğ¾Â Ğ±Ğ¾Ñ‚Ğ°.")
Â Â Â Â Â Â Â Â asyncio.create_task(delete_message_after_delay(bot_message,Â delay=5))
Â Â Â Â Â Â Â Â returnÂ True
Â Â Â Â returnÂ False

asyncÂ defÂ delete_message_after_delay(message:Â types.Message,Â delay:Â int):
Â Â Â Â awaitÂ asyncio.sleep(delay)
Â Â Â Â try:
Â Â Â Â Â Â Â Â awaitÂ message.delete()
Â Â Â Â exceptÂ TelegramBadRequest:
Â Â Â Â Â Â Â Â pass
Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â print(f"ĞĞµÂ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒÂ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒÂ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµÂ {message.message_id}:Â {e}")

asyncÂ defÂ del_msg(chat_id,Â list_delete_message):
Â Â Â Â forÂ msg_idÂ inÂ list_delete_message:
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â awaitÂ bot.delete_message(chat_id,Â msg_id)
Â Â Â Â Â Â Â Â Â Â Â awaitÂ asyncio.sleep(0.1)
Â Â Â Â Â Â Â Â exceptÂ TelegramBadRequest:Â pass
Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°Â ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸ÑÂ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÂ {msg_id}:Â {e}")

classÂ UserLimits:
Â Â Â Â defÂ __init__(self,Â max_files,Â max_size):
Â Â Â Â Â Â Â Â self.user_dataÂ =Â {}
Â Â Â Â Â Â Â Â self.last_global_resetÂ =Â self._get_last_utc_midnight()
Â Â Â Â Â Â Â Â self.user_locksÂ =Â {}
Â Â Â Â Â Â Â Â self.max_filesÂ =Â max_files
Â Â Â Â Â Â Â Â self.max_sizeÂ =Â max_size

Â Â Â Â defÂ _get_last_utc_midnight(self):
Â Â Â Â Â Â Â Â nowÂ =Â datetime.now(timezone.utc)
Â Â Â Â Â Â Â Â returnÂ now.replace(hour=0,Â minute=0,Â second=0,Â microsecond=0)

Â Â Â Â defÂ get_lock(self,Â user_id):
Â Â Â Â Â Â Â Â ifÂ user_idÂ notÂ inÂ self.user_locks:
Â Â Â Â Â Â Â Â Â Â Â Â self.user_locks[user_id]Â =Â asyncio.Lock()
Â Â Â Â Â Â Â Â returnÂ self.user_locks[user_id]

Â Â Â Â defÂ check_limits(self,Â user_id,Â file_size):
Â Â Â Â Â Â Â Â nowÂ =Â datetime.now(timezone.utc)
Â Â Â Â Â Â Â Â ifÂ nowÂ >Â self.last_global_resetÂ +Â timedelta(days=1):
Â Â Â Â Â Â Â Â Â Â Â Â self.user_data.clear()
Â Â Â Â Â Â Â Â Â Â Â Â self.last_global_resetÂ =Â self._get_last_utc_midnight()
Â Â Â Â Â Â Â Â ifÂ user_idÂ notÂ inÂ self.user_data:
Â Â Â Â Â Â Â Â Â Â Â Â self.user_data[user_id]Â =Â {'files_today':Â 0}
Â Â Â Â Â Â Â Â ifÂ file_sizeÂ >Â self.max_sizeÂ *Â 1024Â *Â 1024:
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ False,Â f"âŒÂ Ğ Ğ°Ğ·Ğ¼ĞµÑ€Â Ñ„Ğ°Ğ¹Ğ»Ğ°Â Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚Â {self.max_size}Â MB."
Â Â Â Â Â Â Â Â ifÂ self.user_data[user_id]['files_today']Â >=Â self.max_files:Â #Â Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾Â ==Â Ğ½Ğ°Â >=
Â Â Â Â Â Â Â Â Â Â Â Â time_leftÂ =Â (self.last_global_resetÂ +Â timedelta(days=1))Â -Â now
Â Â Â Â Â Â Â Â Â Â Â Â hours_leftÂ =Â time_left.secondsÂ //Â 3600
Â Â Â Â Â Â Â Â Â Â Â Â minutes_leftÂ =Â (time_left.secondsÂ %Â 3600)Â //Â 60
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ False,Â f"âŒÂ Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Â Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Â ({self.max_files}/{self.max_files}).Â Ğ¡Ğ±Ñ€Ğ¾ÑÂ Ñ‡ĞµÑ€ĞµĞ·Â {hours_left}Â Ñ‡.Â {minutes_left}Â Ğ¼Ğ¸Ğ½.Â (Ğ²Â 00:00Â UTC)."
Â Â Â Â Â Â Â Â returnÂ True,Â ""

Â Â Â Â defÂ increment_counter(self,Â user_id):
Â Â Â Â Â Â Â Â self.user_data[user_id]['files_today']Â +=Â 1

Â Â Â Â defÂ discrement_counter(self,Â user_id,Â count):Â #Â decrement
Â Â Â Â Â Â Â Â ifÂ user_idÂ inÂ self.user_data:
Â Â Â Â Â Â Â Â Â Â Â Â self.user_data[user_id]['files_today']Â =Â max(0,Â self.user_data[user_id]['files_today']Â -Â count)


user_limitsÂ =Â UserLimits(max_files=30,Â max_size=15)Â #Â ĞœĞ°ĞºÑ.Â Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Â 15ĞœĞ‘Â Ğ´Ğ»ÑÂ CalibreÂ Ğ¼Ğ¾Ğ¶ĞµÑ‚Â Ğ±Ñ‹Ñ‚ÑŒÂ Ğ¼Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚

classÂ TaskQueue:
Â Â Â Â defÂ __init__(self,Â max_concurrent_tasks):
Â Â Â Â Â Â Â Â self.queueÂ =Â deque()
Â Â Â Â Â Â Â Â self.active_tasksÂ =Â {}
Â Â Â Â Â Â Â Â self.max_concurrent_tasksÂ =Â max_concurrent_tasks
Â Â Â Â Â Â Â Â self.task_counterÂ =Â 0

Â Â Â Â defÂ add_task(self,Â user_id,Â chat_id,Â message_thread_id,Â is_forum,Â file_list,Â output_file_name):
Â Â Â Â Â Â Â Â self.task_counterÂ +=Â 1
Â Â Â Â Â Â Â Â task_idÂ =Â self.task_counter
Â Â Â Â Â Â Â Â taskÂ =Â {
Â Â Â Â Â Â Â Â Â Â Â Â 'user_id':Â user_id,Â 'chat_id':Â chat_id,Â 'message_thread_id':Â message_thread_id,
Â Â Â Â Â Â Â Â Â Â Â Â 'is_forum':Â is_forum,Â 'file_list':Â file_list,Â 'output_file_name':Â output_file_name,
Â Â Â Â Â Â Â Â Â Â Â Â 'task_id':Â task_id,Â 'time_added':Â time.time(),Â 'list_delete_message':Â []
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â self.queue.append(task)
Â Â Â Â Â Â Â Â returnÂ task,Â len(self.queue)

Â Â Â Â defÂ get_next_task(self):
Â Â Â Â Â Â Â Â ifÂ notÂ self.queue:Â returnÂ None
Â Â Â Â Â Â Â Â taskÂ =Â self.queue.popleft()
Â Â Â Â Â Â Â Â self.active_tasks[task['task_id']]Â =Â task
Â Â Â Â Â Â Â Â returnÂ task

Â Â Â Â defÂ complete_task(self,Â task_id):
Â Â Â Â Â Â Â Â ifÂ task_idÂ inÂ self.active_tasks:
Â Â Â Â Â Â Â Â Â Â Â Â delÂ self.active_tasks[task_id]

Â Â Â Â defÂ get_user_tasks(self,Â user_id):
Â Â Â Â Â Â Â Â tasksÂ =Â [tÂ forÂ t_id,Â tÂ inÂ self.active_tasks.items()Â ifÂ t['user_id']Â ==Â user_id]
Â Â Â Â Â Â Â Â tasks.extend([tÂ forÂ tÂ inÂ self.queueÂ ifÂ t['user_id']Â ==Â user_id])
Â Â Â Â Â Â Â Â returnÂ tasks

Â Â Â Â defÂ can_process_now(self):
Â Â Â Â Â Â Â Â returnÂ len(self.active_tasks)Â <Â self.max_concurrent_tasksÂ andÂ self.queue

task_queueÂ =Â TaskQueue(max_concurrent_tasks=1)

defÂ timer(func):
Â Â Â Â asyncÂ defÂ wrapper(*args,Â **kwargs):
Â Â Â Â Â Â Â Â start_timeÂ =Â time.time()
Â Â Â Â Â Â Â Â resultÂ =Â awaitÂ func(*args,Â **kwargs)
Â Â Â Â Â Â Â Â elapsedÂ =Â time.time()Â -Â start_time
Â Â Â Â Â Â Â Â print(f"[PROFILING]Â Ğ¤ÑƒĞ½ĞºÑ†Ğ¸ÑÂ {func.__name__}Â Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ğ»Ğ°ÑÑŒÂ Ğ·Ğ°Â {elapsed:.2f}Â ÑĞµĞºÑƒĞ½Ğ´")
Â Â Â Â Â Â Â Â returnÂ result
Â Â Â Â returnÂ wrapper

API_TOKENÂ =Â '7885126039:AAEzZPYvJhN2rncjtSiYPGa194cDEcZODyE'
botÂ =Â Bot(token=API_TOKEN)
routerÂ =Â Router()

asyncÂ defÂ run_in_threadpool(func,Â *args,Â **kwargs):
Â Â Â Â loopÂ =Â asyncio.get_running_loop()
Â Â Â Â func_partialÂ =Â partial(func,Â *args,Â **kwargs)
Â Â Â Â returnÂ awaitÂ loop.run_in_executor(thread_pool,Â func_partial)

#Â ---Â ĞĞ¾Ğ²Ğ°ÑÂ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑÂ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ñ‡ĞµÑ€ĞµĞ·Â CalibreÂ ---
asyncÂ defÂ convert_file_to_docx_with_calibre(input_file,Â docx_file,Â ext):
Â Â Â Â """ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚Â Ñ„Ğ°Ğ¹Ğ»Â Ğ²Â DOCXÂ ÑÂ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑÂ Calibre."""
Â Â Â Â defÂ _convert_sync():
Â Â Â Â Â Â Â Â ifÂ notÂ IS_CALIBRE_AVAILABLE:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°:Â CalibreÂ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.Â ĞĞµÂ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒÂ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÂ {os.path.basename(input_file)}")
Â Â Â Â Â Â Â Â Â Â Â Â error_docÂ =Â Document()
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.add_paragraph(f"ĞÑˆĞ¸Ğ±ĞºĞ°:Â Ğ¡ĞµÑ€Ğ²Ğ¸ÑÂ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â CalibreÂ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Â Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.Â ĞĞµÂ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒÂ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒÂ Ñ„Ğ°Ğ¹Ğ»:Â {os.path.basename(input_file)}")
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.save(docx_file)
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ FalseÂ #Â Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸

Â Â Â Â Â Â Â Â commandÂ =Â [CALIBRE_CONVERT_PATH,Â input_file,Â docx_file,Â "--docx-no-toc"]
Â Â Â Â Â Â Â Â ifÂ extÂ ==Â ".fb2":
Â Â Â Â Â Â Â Â Â Â Â Â command.append("--no-inline-fb2-toc")
Â Â Â Â Â Â Â Â #Â ĞĞ¿Ñ†Ğ¸Ğ¸Â CalibreÂ Ğ´Ğ»ÑÂ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸ÑÂ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ğ²Â DOCXÂ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾Â Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ)
Â Â Â Â Â Â Â Â #Â command.extend(["--docx-page-size",Â "a4"])Â #Â ĞŸÑ€Ğ¸Ğ¼ĞµÑ€

Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ¼Â Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚,Â Ñ‚.Ğº.Â CalibreÂ Ğ¼Ğ¾Ğ¶ĞµÑ‚Â Ğ´Ğ¾Ğ»Ğ³Ğ¾Â Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒÂ ÑÂ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸
Â Â Â Â Â Â Â Â Â Â Â Â resultÂ =Â subprocess.run(command,Â capture_output=True,Â text=True,Â errors='ignore',Â check=False,Â timeout=600)Â #Â 10Â Ğ¼Ğ¸Ğ½ÑƒÑ‚

Â Â Â Â Â Â Â Â Â Â Â Â ifÂ result.returncodeÂ !=Â 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â CalibreÂ Ğ´Ğ»ÑÂ Ñ„Ğ°Ğ¹Ğ»Ğ°Â {input_file}Â (ĞºĞ¾Ğ´Â {result.returncode}):")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â print(f"STDOUT:Â {result.stdout}")Â #Â Ğ§Ğ°ÑÑ‚Ğ¾Â Ğ·Ğ´ĞµÑÑŒÂ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Â Ğ¼ÑƒÑĞ¾Ñ€Ğ°
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"STDERR:Â {result.stderr}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_docÂ =Â Document()
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_messageÂ =Â f"ĞÑˆĞ¸Ğ±ĞºĞ°Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Ğ°Â {os.path.basename(input_file)}Â ÑÂ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑÂ Calibre.\n"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ result.stderr:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_messageÂ +=Â "Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµÂ Ğ¾Ñ‚Â CalibreÂ (Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚):\n"Â +Â result.stderr[:1500]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_messageÂ +=Â "CalibreÂ Ğ½ĞµÂ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Â Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹Â Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸Â Ğ¾Ğ±Â Ğ¾ÑˆĞ¸Ğ±ĞºĞµ."
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_doc.add_paragraph(error_message)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_doc.save(docx_file)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ False
Â Â Â Â Â Â Â Â Â Â Â Â print(f"Ğ¤Ğ°Ğ¹Ğ»Â {input_file}Â ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Â ÑĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Â Ğ²Â {docx_file}Â ÑÂ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑÂ Calibre.")
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ True
Â Â Â Â Â Â Â Â exceptÂ subprocess.TimeoutExpired:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°:Â ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸ÑÂ Ñ„Ğ°Ğ¹Ğ»Ğ°Â {input_file}Â ÑÂ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑÂ CalibreÂ Ğ·Ğ°Ğ½ÑĞ»Ğ°Â ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼Â Ğ¼Ğ½Ğ¾Ğ³Ğ¾Â Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸Â (>10Â Ğ¼Ğ¸Ğ½).")
Â Â Â Â Â Â Â Â Â Â Â Â error_docÂ =Â Document()
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.add_paragraph(f"ĞÑˆĞ¸Ğ±ĞºĞ°:Â ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°Â Ñ„Ğ°Ğ¹Ğ»Ğ°Â {os.path.basename(input_file)}Â Ğ·Ğ°Ğ½ÑĞ»Ğ°Â ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼Â Ğ¼Ğ½Ğ¾Ğ³Ğ¾Â Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸Â Ğ¸Â Ğ±Ñ‹Ğ»Ğ°Â Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ°.")
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.save(docx_file)
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ False
Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ²Ñ‹Ğ·Ğ¾Ğ²ĞµÂ CalibreÂ Ğ´Ğ»ÑÂ {input_file}:Â {e}")
Â Â Â Â Â Â Â Â Â Â Â Â error_docÂ =Â Document()
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.add_paragraph(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°ÑÂ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Ğ°Â {os.path.basename(input_file)}:Â {e}")
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.save(docx_file)
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ False

Â Â Â Â returnÂ awaitÂ run_in_threadpool(_convert_sync)


@timer
asyncÂ defÂ process_files(file_list):
Â Â Â Â converted_filesÂ =Â []
Â Â Â Â #Â ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹ĞµÂ CalibreÂ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹Â Ğ´Ğ»ÑÂ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ğ²Â DOCXÂ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾Â Ñ€Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ)
Â Â Â Â CALIBRE_SUPPORTED_INPUT_EXTÂ =Â (".docx",Â ".txt",Â ".fb2",Â ".epub",Â ".mobi",Â ".azw3",Â ".rtf",Â ".html",Â ".htm",Â ".lit")

Â Â Â Â forÂ file_pathÂ inÂ file_list:
Â Â Â Â Â Â Â Â base_name,Â extÂ =Â os.path.splitext(file_path)
Â Â Â Â Â Â Â Â extÂ =Â ext.lower()

Â Â Â Â Â Â Â Â #ifÂ extÂ ==Â ".docx":
Â Â Â Â Â Â Â Â Â Â Â Â #converted_files.append(file_path)
Â Â Â Â Â Â Â Â ifÂ extÂ inÂ CALIBRE_SUPPORTED_INPUT_EXT:
Â Â Â Â Â Â Â Â Â Â Â Â docx_fileÂ =Â base_nameÂ +Â "1"Â +Â ".docx"
Â Â Â Â Â Â Â Â Â Â Â Â #Â ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Â ÑÂ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑÂ Calibre
Â Â Â Â Â Â Â Â Â Â Â Â successÂ =Â awaitÂ convert_file_to_docx_with_calibre(file_path,Â docx_file,Â ext)
Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼Â Ñ„Ğ°Ğ¹Ğ»Â Ğ²Â Ğ»ÑĞ±Ğ¾Ğ¼Â ÑĞ»ÑƒÑ‡Ğ°ĞµÂ (ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹Â Ğ¸Ğ»Ğ¸Â ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹),
Â Â Â Â Â Â Â Â Â Â Â Â #Â Ñ‡Ñ‚Ğ¾Ğ±Ñ‹Â Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÂ Ğ²Ğ¸Ğ´ĞµĞ»Â Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Â Ğ¸Ğ»Ğ¸Â Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ.
Â Â Â Â Â Â Â Â Â Â Â Â converted_files.append(docx_file)
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞĞµĞ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹Â Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Â Ñ„Ğ°Ğ¹Ğ»Ğ°:Â {file_path}.Â Ğ‘ÑƒĞ´ĞµÑ‚Â ÑĞ¾Ğ·Ğ´Ğ°Ğ½Â DOCXÂ ÑÂ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼.")
Â Â Â Â Â Â Â Â Â Â Â Â docx_fileÂ =Â base_nameÂ +Â "_unsupported_format.docx"
Â Â Â Â Â Â Â Â Â Â Â Â error_docÂ =Â Document()
Â Â Â Â Â Â Â Â Â Â Â Â error_doc.add_paragraph(f"Ğ¤Ğ°Ğ¹Ğ»Â '{os.path.basename(file_path)}'Â Ğ¸Ğ¼ĞµĞµÑ‚Â Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚,Â ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹Â Ğ½ĞµÂ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑÂ Ğ´Ğ»ÑÂ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸.")

Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµÂ Ğ²Â Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ,Â Ñ‚Ğ°ĞºÂ ĞºĞ°ĞºÂ Document.save()Â Ğ¼Ğ¾Ğ¶ĞµÑ‚Â Ğ±Ñ‹Ñ‚ÑŒÂ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¼
Â Â Â Â Â Â Â Â Â Â Â Â defÂ _save_error_doc_sync():
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_doc.save(docx_file)
Â Â Â Â Â Â Â Â Â Â Â Â awaitÂ run_in_threadpool(_save_error_doc_sync)
Â Â Â Â Â Â Â Â Â Â Â Â converted_files.append(docx_file)

Â Â Â Â returnÂ converted_files

#Â =====================Â Ğ¤ÑƒĞ½ĞºÑ†Ğ¸ÑÂ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ÑÂ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Â (Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑÂ Ğ±ĞµĞ·Â Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)Â =====
defÂ check_and_add_title(doc,Â file_name):
Â Â Â Â patternsÂ =Â [
Â Â Â Â Â Â Â Â r'Ğ“Ğ»Ğ°Ğ²Ğ°[Â ]{0,4}\d{1,4}',Â r'Ğ§Ğ°ÑÑ‚ÑŒ[Â ]{0,4}\d{1,4}',Â r'ĞŸÑ€Ğ¾Ğ»Ğ¾Ğ³[Â .!]*',
Â Â Â Â Â Â Â Â r'ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ[Â .!]*',Â r'ĞĞ½Ğ½Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ[Â .!]*',Â r'Annotation[Â .!]*',
Â Â Â Â Â Â Â Â r'ĞŸÑ€ĞµĞ´Ğ¸ÑĞ»Ğ¾Ğ²Ğ¸ĞµÂ Ğ¾Ñ‚Â Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°[Â .!]*'
Â Â Â Â ]
Â Â Â Â ifÂ doc.paragraphs:
Â Â Â Â Â Â Â Â check_paragraphsÂ =Â doc.paragraphs[0:min(4,Â len(doc.paragraphs))]Â #Â Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°Â Ğ¾Ñ‚Â ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ñ…Â Ğ´Ğ¾Ğº-Ğ¾Ğ²
Â Â Â Â Â Â Â Â title_foundÂ =Â False
Â Â Â Â Â Â Â Â forÂ pÂ inÂ check_paragraphs:
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ any(p.style.name.lower().startswith(prefix)Â forÂ prefixÂ inÂ ["heading",Â "Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº"]):
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â title_foundÂ =Â True;Â break
Â Â Â Â Â Â Â Â ifÂ notÂ title_found:
Â Â Â Â Â Â Â Â Â Â Â Â forÂ pÂ inÂ check_paragraphs:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ patternÂ inÂ patterns:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ re.fullmatch(pattern,Â p.text.strip(),Â re.IGNORECASE):Â #Â Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Â IGNORECASE
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â title_foundÂ =Â True;Â break
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ title_found:Â break
Â Â Â Â Â Â Â Â ifÂ notÂ title_found:
Â Â Â Â Â Â Â Â Â Â Â Â titleÂ =Â os.path.splitext(os.path.basename(file_name))[0]
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ re.fullmatch(r'\d+',Â title.strip()):Â titleÂ =Â 'Ğ“Ğ»Ğ°Ğ²Ğ°Â 'Â +Â title
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â headingÂ =Â doc.add_heading(title,Â level=1)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â doc._body._element.insert(0,Â heading._element)
Â Â Â Â Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:Â #Â Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹Â Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚,Â ĞµÑĞ»Ğ¸Â Ğ²ÑÑ‚Ğ°Ğ²ĞºĞ°Â ÑĞ»Ğ¾Ğ¼Ğ°Ğ»Ğ°ÑÑŒ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â paragraphÂ =Â doc.paragraphs[0].insert_paragraph_before(title)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â paragraph.styleÂ =Â 'HeadingÂ 1'Â #Â ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Â Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÂ ÑÑ‚Ğ¸Ğ»ÑŒ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e_inner:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"Ğ’Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ°Â Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸Â Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Â (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°ÑÂ Ğ¸Â Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ°Ñ):Â {e},Â {e_inner}")

Â Â Â Â returnÂ doc

@timer
asyncÂ defÂ merge_docx(file_list,Â output_file_name):
Â Â Â Â defÂ _merge():
Â Â Â Â Â Â Â Â merged_documentÂ =Â Document()
Â Â Â Â Â Â Â Â composerÂ =Â Composer(merged_document)
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â forÂ file_pathÂ inÂ file_list:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼,Â ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚Â Ğ»Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Â Ğ¸Â Ğ½ĞµÂ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹Â Ğ»Ğ¸Â Ğ¾Ğ½Â (CalibreÂ Ğ¼Ğ¾Ğ³Â ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒÂ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹Â Ñ„Ğ°Ğ¹Ğ»Â Ğ¿Ñ€Ğ¸Â Ğ¾ÑˆĞ¸Ğ±ĞºĞµ)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ os.path.exists(file_path)Â andÂ os.path.getsize(file_path)Â >Â 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â docÂ =Â Document(file_path)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â docÂ =Â check_and_add_title(doc,Â file_path)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â composer.append(doc)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ¤Ğ°Ğ¹Ğ»Â Ğ½ĞµÂ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚Â Ğ¸Ğ»Ğ¸Â Ğ¿ÑƒÑÑ‚Â (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾,Â Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼Â Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ÑÂ Ğ¾Ğ±Â ÑÑ‚Ğ¾Ğ¼Â Ğ²Â Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹Â Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_paragraph_textÂ =Â f"Ğ¤Ğ°Ğ¹Ğ»Â '{os.path.basename(file_path)}'Â Ğ½ĞµÂ Ğ±Ñ‹Ğ»Â Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Â Ğ¸Ğ·-Ğ·Ğ°Â Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸Â ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸Â Ğ¸Ğ»Ğ¸Â Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸ÑÂ Ñ„Ğ°Ğ¹Ğ»Ğ°."
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ notÂ os.path.exists(file_path):
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â error_paragraph_textÂ =Â f"Ğ¤Ğ°Ğ¹Ğ»Â '{os.path.basename(file_path)}'Â Ğ½ĞµÂ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Â Ğ¸Â Ğ½ĞµÂ Ğ±Ñ‹Ğ»Â Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½."
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(error_paragraph_text)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â merged_document.add_paragraph(error_paragraph_text)

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞÑˆĞ¸Ğ±ĞºĞ°Â Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ÑÂ Ñ„Ğ°Ğ¹Ğ»Ğ°Â {file_path}Â Ğ²Â Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹Â Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚:Â {e}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â merged_document.add_paragraph(f"ĞÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµÂ Ñ„Ğ°Ğ¹Ğ»Ğ°Â {os.path.basename(file_path)}:Â {e}")
Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ e:
Â Â Â Â Â Â Â Â Â Â Â Â print(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Â {file_list}:Â {e}")
Â Â Â Â Â Â Â Â Â Â Â Â merged_document.add_paragraph(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°ÑÂ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Â Ğ¿Ñ€Ğ¸Â Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¸Â Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²:Â {e}")
Â Â Â Â Â Â Â Â finally:
Â Â Â Â Â Â Â Â Â Â Â Â composer.save(output_file_name)
Â Â Â Â Â Â Â Â Â Â Â Â print(f"Ğ¤Ğ°Ğ¹Ğ»Ñ‹Â Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ñ‹Â Ğ²Â {output_file_name}")
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ output_file_name
Â Â Â Â returnÂ awaitÂ run_in_threadpool(_merge)

#Â =====================Â FSM:Â Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑÂ (Ğ±ĞµĞ·Â Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)Â =====================
classÂ MergeStates(StatesGroup):
Â Â Â Â collectingÂ =Â State()
Â Â Â Â naming_fileÂ =Â State()

#Â =====================Â ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸Â Telegram-Ğ±Ğ¾Ñ‚Ğ°Â (Ğ²Â Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼Â Ğ±ĞµĞ·Â Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)Â =====================
@router.message(Command("start_merge"))
asyncÂ defÂ start_merge(message:Â Message,Â state:Â FSMContext):
Â Â Â Â ifÂ awaitÂ check_sender(message):Â return
Â Â Â Â current_stateÂ =Â awaitÂ state.get_state()
Â Â Â Â ifÂ current_stateÂ ==Â MergeStates.collecting.state:
Â Â Â Â Â Â Â Â bot_messageÂ =Â awaitÂ message.answer("Ğ¡Ğ±Ğ¾Ñ€Â Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Â ÑƒĞ¶ĞµÂ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½.")
Â Â Â Â Â Â Â Â awaitÂ message.delete()
Â Â Â Â Â Â Â Â asyncio.create_task(delete_message_after_delay(bot_message,Â delay=5))
Â Â Â Â Â Â Â Â return
Â Â Â Â awaitÂ state.set_state(MergeStates.collecting)
Â Â Â Â bot_messageÂ =Â awaitÂ message.answer("Ğ¡Ğ±Ğ¾Ñ€Â Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Â Ğ½Ğ°Ñ‡Ğ°Ñ‚!Â ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚ĞµÂ Ñ„Ğ°Ğ¹Ğ»Ñ‹.Â Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚ĞµÂ /end_mergeÂ Ğ´Ğ»ÑÂ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸ÑÂ Ğ¸Ğ»Ğ¸Â /cancelÂ Ğ´Ğ»ÑÂ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹.")
Â Â Â Â awaitÂ state.update_data(file_list=[],Â list_delete_message=[bot_message.message_id])
Â Â Â Â awaitÂ message.delete()

defÂ build_task_status(user_id):
Â Â Â Â user_tasksÂ =Â task_queue.get_user_tasks(user_id)
Â Â Â Â ifÂ notÂ user_tasks:
Â Â Â Â Â Â Â Â total_tasks_in_queueÂ =Â len(task_queue.queue)Â #Â Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾Â Ñ‚ĞµÂ Ñ‡Ñ‚Ğ¾Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
Â Â Â Â Â Â Â Â active_tasks_countÂ =Â len(task_queue.active_tasks)
Â Â Â Â Â Â Â Â textÂ =Â f"Ğ£Â Ğ²Ğ°ÑÂ Ğ½ĞµÑ‚Â Ğ·Ğ°Ğ´Ğ°Ñ‡Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸.\nĞ¡Ñ‚Ğ°Ñ‚ÑƒÑÂ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹:Â {active_tasks_count}/{task_queue.max_concurrent_tasks}Â Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…,Â {total_tasks_in_queue}Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸."
Â Â Â Â Â Â Â Â returnÂ text,Â None

Â Â Â Â tasks_infoÂ =Â []
Â Â Â Â keyboard_buttonsÂ =Â []
Â Â Â Â forÂ i,Â taskÂ inÂ enumerate(user_tasks):Â #Â Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Â enumerateÂ Ğ´Ğ»ÑÂ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
Â Â Â Â Â Â Â Â task_idÂ =Â task['task_id']
Â Â Â Â Â Â Â Â task_nameÂ =Â os.path.basename(task['file_list'][0])Â ifÂ task['file_list']Â elseÂ "Ğ‘ĞµĞ·Â Ğ¸Ğ¼ĞµĞ½Ğ¸"
Â Â Â Â Â Â Â Â ifÂ len(task['file_list'])Â >Â 1:Â task_nameÂ +=Â f"Â Ğ¸Â ĞµÑ‰ĞµÂ {len(task['file_list'])-1}"

Â Â Â Â Â Â Â Â status_strÂ =Â ""
Â Â Â Â Â Â Â Â ifÂ task_idÂ inÂ task_queue.active_tasks:
Â Â Â Â Â Â Â Â Â Â Â Â status_strÂ =Â "âš™ï¸Â Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑÂ (Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÂ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾)"
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ˜Ñ‰ĞµĞ¼Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸Â Ğ´Ğ»ÑÂ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸ÑÂ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ­Ñ‚Ğ¾Â Ğ½ĞµÂ ÑĞ¾Ğ²ÑĞµĞ¼Â Ñ‚Ğ¾Ñ‡Ğ½Ğ¾,Â Ñ‚.Ğº.Â get_user_tasksÂ ÑƒĞ¶ĞµÂ Ğ²ĞµÑ€Ğ½ÑƒĞ»Â Ğ²ÑĞµÂ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸Â Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
Â Â Â Â Â Â Â Â Â Â Â Â #Â ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ĞµĞµÂ Ğ±Ñ‹Ğ»Ğ¾Â Ğ±Ñ‹Â Ğ½Ğ°Ğ¹Ñ‚Ğ¸Â Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑÂ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸Â Ğ²Â self.queue,Â ĞµÑĞ»Ğ¸Â Ğ¾Ğ½Ğ°Â Ñ‚Ğ°Ğ¼Â ĞµÑÑ‚ÑŒ
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Â Ğ¸Ğ½Ğ´ĞµĞºÑÂ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸Â Ğ²Â Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸Â task_queue.queue
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â Ğ­Ñ‚Ğ¾Â Ğ¼Ğ¾Ğ¶ĞµÑ‚Â Ğ±Ñ‹Ñ‚ÑŒÂ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾Â Ğ½Ğ°Â Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ…Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑÑ…,Â Ğ½Ğ¾Â Ğ´Ğ»ÑÂ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸...
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â queue_indicesÂ =Â [idxÂ forÂ idx,Â q_taskÂ inÂ enumerate(task_queue.queue)Â ifÂ q_task['task_id']Â ==Â task_id]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ queue_indices:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â status_strÂ =Â f"ğŸ•’Â Ğ’Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸Â (Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑÂ {queue_indices[0]+1})"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else:Â #Â Ğ•ÑĞ»Ğ¸Â Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸Â Ğ½ĞµÑ‚Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸,Â Ğ½Ğ¾Â Ğ¾Ğ½Ğ°Â Ğ¸Â Ğ½ĞµÂ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Â (Ñ€ĞµĞ´ĞºĞ¸Ğ¹Â ÑĞ»ÑƒÑ‡Ğ°Ğ¹,Â Ğ¼Ğ¾Ğ¶ĞµÑ‚Â Ğ±Ñ‹Ñ‚ÑŒÂ ÑÑ€Ğ°Ğ·ÑƒÂ Ğ¿Ğ¾ÑĞ»ĞµÂ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â status_strÂ =Â "â”Â ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹Â ÑÑ‚Ğ°Ñ‚ÑƒÑ"
Â Â Â Â Â Â Â Â Â Â Â Â exceptÂ ValueError:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â status_strÂ =Â "â”Â Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÂ Ğ½ĞµÂ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Â (Ğ½ĞµÂ Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸)"


Â Â Â Â Â Â Â Â tasks_info.append(f"Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°Â #{task_id}:Â {task_name}Â -Â {status_str}")
Â Â Â Â Â Â Â Â ifÂ task_idÂ notÂ inÂ task_queue.active_tasksÂ andÂ status_str.startswith("ğŸ•’"):Â #Â Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾Â ĞµÑĞ»Ğ¸Â Ğ²Â Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
Â Â Â Â Â Â Â Â Â Â Â Â keyboard_buttons.append(InlineKeyboardButton(text=f"ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÂ #{task_id}",Â callback_data=f"cancel_task:{task_id}"))Â #Â Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Â cancelÂ ->Â cancel_task

Â Â Â Â textÂ =Â "Ğ’Ğ°ÑˆĞ¸Â Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:\n\n"Â +Â "\n".join(tasks_info)
Â Â Â Â reply_markupÂ =Â InlineKeyboardMarkup(inline_keyboard=[keyboard_buttons[i:i+2]Â forÂ iÂ inÂ range(0<
